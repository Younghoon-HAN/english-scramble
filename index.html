<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Scramble - ëª©ì ê²© ê´€ê³„ëŒ€ëª…ì‚¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Pretendard', sans-serif; transition: all 0.3s; }
        .dark { background-color: #0f172a; color: #f1f5f9; }
        .word-tile { transition: all 0.2s; cursor: pointer; user-select: none; }
        .word-tile.selected { opacity: 0.3; pointer-events: none; }
        .drop-zone { min-height: 80px; border: 2px dashed #e2e8f0; border-radius: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .dark .drop-zone { border-color: #334155; background-color: #1e293b; }
        .correct { border-color: #22c55e !important; background-color: #f0fdf4 !important; }
        .incorrect { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 100; align-items: center; justify-content: center; padding: 1rem; }
        .modal.active { display: flex; }
        #custom-alert { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col items-center p-4">

    <div id="custom-alert" class="bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl font-bold text-sm animate-bounce"></div>

    <div id="login-modal" class="modal active">
        <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-[2.5rem] p-10 shadow-2xl text-center border border-slate-100">
            <h2 class="text-3xl font-black text-slate-800 dark:text-white mb-2">ëª©ì ê²© ê´€ê³„ëŒ€ëª…ì‚¬</h2>
            <p class="text-slate-500 dark:text-slate-400 mb-8">í•™ìŠµì„ ì‹œì‘í•˜ë ¤ë©´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
            <input type="text" id="user-nickname" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" 
                   class="w-full p-4 rounded-2xl border border-slate-200 dark:border-slate-700 dark:bg-slate-900 mb-4 outline-none focus:ring-4 focus:ring-indigo-500/20 text-center font-bold text-lg">
            <button id="start-btn" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black text-lg hover:bg-indigo-700 transition-all shadow-xl shadow-indigo-200">í•™ìŠµ ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>

    <nav class="w-full max-w-2xl flex justify-between items-center mb-6 py-2 px-4">
        <div class="flex items-center gap-3">
            <div id="user-avatar" class="w-11 h-11 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center text-white font-black shadow-lg">?</div>
            <div>
                <p id="display-name" class="text-sm font-black dark:text-white">ì ‘ì† ì¤‘...</p>
                <p class="text-[11px] font-bold text-slate-400 uppercase tracking-tighter">Live Sync</p>
            </div>
        </div>
        <div class="flex gap-2.5">
            <button id="rank-btn" class="p-3 rounded-2xl bg-white shadow-sm border border-slate-200">ğŸ† ìˆœìœ„í‘œ</button>
            <button id="admin-btn" class="p-3 rounded-2xl bg-white shadow-sm border border-slate-200">âš™ï¸</button>
        </div>
    </nav>

    <main id="game-container" class="w-full max-w-2xl bg-white shadow-2xl rounded-[3rem] p-8 md:p-12 border border-slate-100 relative overflow-hidden">
        <div class="flex justify-between items-start mb-8">
            <div class="flex-1">
                <div id="level-badge" class="inline-block px-3 py-1 bg-indigo-50 text-indigo-600 rounded-lg text-[10px] font-black uppercase mb-3">Loading...</div>
                <h2 id="translation" class="text-2xl md:text-3xl font-black text-slate-800 leading-tight">ë¬¸ì¥ì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤.</h2>
            </div>
            <div class="bg-slate-50 p-4 rounded-[1.5rem] text-center min-w-[100px]">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Score</p>
                <p id="score-display" class="text-3xl font-black text-indigo-600">0</p>
            </div>
        </div>
        <div class="w-full bg-slate-100 h-2.5 rounded-full mb-10 overflow-hidden">
            <div id="progress-bar" class="bg-gradient-to-r from-indigo-500 to-purple-600 h-full w-0 transition-all duration-700"></div>
        </div>
        <div id="answer-zone" class="drop-zone p-5 bg-slate-50/50 mb-8"></div>
        <div id="word-pool" class="flex flex-wrap gap-2.5 justify-center mb-12"></div>
        <div class="grid grid-cols-2 gap-4">
            <button id="reset-btn" class="py-5 bg-slate-100 text-slate-600 rounded-[1.5rem] font-black">ì´ˆê¸°í™”</button>
            <button id="check-btn" class="py-5 bg-indigo-600 text-white rounded-[1.5rem] font-black">ì •ë‹µ í™•ì¸</button>
            <button id="next-btn" class="hidden col-span-2 py-5 bg-emerald-500 text-white rounded-[1.5rem] font-black">ë‹¤ìŒ ë¬¸ì¥ìœ¼ë¡œ</button>
        </div>
        <div id="feedback" class="mt-8 text-center font-black text-xl opacity-0 h-8"></div>
    </main>

    <div id="rank-modal" class="modal"><div class="bg-white w-full max-w-md rounded-[2.5rem] p-10 shadow-2xl relative"><button id="rank-close" class="absolute top-6 right-6 font-bold text-2xl">&times;</button><h3 class="text-2xl font-black mb-8">ğŸ† ì‹¤ì‹œê°„ ìˆœìœ„í‘œ</h3><div id="rank-list" class="space-y-3"></div></div></div>
    
    <div id="admin-modal" class="modal"><div class="bg-white w-full max-w-2xl rounded-[2.5rem] p-10 shadow-2xl max-h-[90vh] overflow-y-auto"><div class="flex justify-between items-center mb-8"><h3 class="text-2xl font-black">AI ë¬¸ì¥ ìƒì„± & ê´€ë¦¬</h3><button id="admin-close" class="text-2xl">&times;</button></div><div class="bg-indigo-50 p-6 rounded-[2rem] mb-8"><p class="text-indigo-600 font-black text-sm mb-4">âœ¨ AI ë¬¸ì¥ ìƒì„±</p><div class="flex gap-2"><input type="text" id="ai-prompt" placeholder="ì£¼ì œ ì…ë ¥ (ì˜ˆ: í•™êµ, ì—¬í–‰)" class="flex-1 p-4 rounded-2xl outline-none"><button id="generate-ai-btn" class="px-8 bg-indigo-600 text-white rounded-2xl font-black">ìƒì„±</button></div><p class="text-[10px] text-indigo-400 mt-2 italic">Gemini APIë¥¼ í†µí•´ ë¬¸ë²•ì— ë§ëŠ” ë¬¸ì¥ì„ ìƒì„±í•©ë‹ˆë‹¤.</p></div><div id="admin-quiz-list" class="space-y-3"></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, updateDoc, increment, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. ë³¸ì¸ì˜ Firebase ì„¤ì •ê°’ìœ¼ë¡œ ë°˜ë“œì‹œ êµì²´í•˜ì„¸ìš” ---
       const firebaseConfig = {
            apiKey: "AIzaSyA3j1y-fDVwULntoBFIVmGlLhROSyk7yRs",
            authDomain: "english-scramble.firebaseapp.com",
            projectId: "english-scramble",
            storageBucket: "english-scramble.firebasestorage.app",
            messagingSenderId: "1051575656252",
            appId: "1:1051575656252:web:1a25ee13efbe8dc47fc839",
            measurementId: "G-L92WNLFTHZ" 
        };

        
        // --- 2. Gemini API í‚¤ ---
        const GEMINI_API_KEY = "AIzaSyAW3PAPC5lBZvqR_xUN0Tr1y3eS-Oe3uPc";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'scramble-app-v1';

        let quizzes = [];
        let currentIdx = 0;
        let selectedWords = [];
        let currentUser = null;

        function showMsg(m) {
            const a = document.getElementById('custom-alert');
            a.innerText = m; a.style.display = 'block';
            setTimeout(() => a.style.display = 'none', 3000);
        }

        document.getElementById('start-btn').onclick = async () => {
            const nick = document.getElementById('user-nickname').value.trim();
            if(!nick) return showMsg("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            
            try {
                if(!auth.currentUser) await signInAnonymously(auth);
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', auth.currentUser.uid);
                await setDoc(userRef, { nickname: nick, score: 0, lastUpdated: Date.now() }, { merge: true });
                document.getElementById('login-modal').classList.remove('active');
            } catch(e) {
                console.error(e);
                showMsg("Firebase ì—°ê²° ì‹¤íŒ¨.");
            }
        };

        onAuthStateChanged(auth, (user) => {
            if(user) {
                currentUser = user;
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'quizzes'), (snap) => {
                    const l = []; snap.forEach(d => l.push({id: d.id, ...d.data()}));
                    quizzes = l.sort((a,b) => (a.createdAt || 0) - (b.createdAt || 0));
                    if(quizzes.length > 0) loadQuiz();
                    updateAdminList();
                });
                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid), (snap) => {
                    if(snap.exists()) {
                        const d = snap.data();
                        document.getElementById('display-name').innerText = d.nickname;
                        document.getElementById('score-display').innerText = d.score || 0;
                        document.getElementById('user-avatar').innerText = d.nickname.charAt(0);
                    }
                });
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snap) => {
                    const ul = []; snap.forEach(d => ul.push({id: d.id, ...d.data()}));
                    renderRank(ul.sort((a,b) => b.score - a.score));
                });
            }
        });

        // AI ë¬¸ì¥ ìƒì„± ë¡œì§
        document.getElementById('generate-ai-btn').onclick = async () => {
            const prompt = document.getElementById('ai-prompt').value.trim();
            if (!prompt) return showMsg("ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            if (!GEMINI_API_KEY || GEMINI_API_KEY === "ë³¸ì¸ì˜_GEMINI_API_KEY") return showMsg("Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");

            const btn = document.getElementById('generate-ai-btn');
            btn.disabled = true;
            btn.innerText = "ìƒì„± ì¤‘...";

            try {
                const systemPrompt = "You are an English teacher. Generate one English sentence using 'Objective Relative Pronoun' (whom, which, that) based on the user's topic. Response must be JSON format: { 'en': 'English sentence', 'ko': 'Korean translation' }";
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Topic: ${prompt}` }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                const data = await response.json();
                const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!resultText) throw new Error("API Response Empty");

                const quizData = JSON.parse(resultText);
                
                // Firestoreì— ì €ì¥
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'quizzes'), {
                    ...quizData,
                    createdAt: Date.now()
                });

                showMsg("ë¬¸ì¥ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
                document.getElementById('ai-prompt').value = '';
            } catch (e) {
                console.error(e);
                showMsg("ìƒì„± ì‹¤íŒ¨: API í‚¤ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
            } finally {
                btn.disabled = false;
                btn.innerText = "ìƒì„±";
            }
        };

        function loadQuiz() {
            if(quizzes.length === 0) return;
            const q = quizzes[currentIdx % quizzes.length];
            document.getElementById('translation').innerText = q.ko;
            document.getElementById('level-badge').innerText = `Sentence ${currentIdx + 1} / ${quizzes.length}`;
            document.getElementById('word-pool').innerHTML = '';
            document.getElementById('answer-zone').innerHTML = '';
            document.getElementById('feedback').style.opacity = '0';
            document.getElementById('check-btn').classList.remove('hidden');
            document.getElementById('next-btn').classList.add('hidden');
            selectedWords = [];

            q.en.split(' ').sort(() => Math.random()-0.5).forEach(w => {
                const b = document.createElement('div');
                b.className = 'word-tile bg-white border p-4 rounded-xl font-bold cursor-pointer';
                b.innerText = w;
                b.onclick = () => {
                    if(b.classList.contains('selected')) return;
                    b.classList.add('selected');
                    const t = document.createElement('div');
                    t.className = 'word-tile bg-indigo-600 text-white p-4 rounded-xl font-bold';
                    t.innerText = w;
                    t.onclick = () => { b.classList.remove('selected'); t.remove(); selectedWords = selectedWords.filter(s => s.t !== t); };
                    document.getElementById('answer-zone').appendChild(t);
                    selectedWords.push({w, t});
                };
                document.getElementById('word-pool').appendChild(b);
            });
        }

        document.getElementById('check-btn').onclick = async () => {
            const userStr = selectedWords.map(s => s.w.toLowerCase().replace(/[.?!,]/g,"")).join(' ');
            const correctStr = quizzes[currentIdx % quizzes.length].en.toLowerCase().replace(/[.?!,]/g,"");
            const f = document.getElementById('feedback');
            if(userStr === correctStr) {
                f.innerText = "ì •ë‹µ!"; f.style.opacity = '1';
                document.getElementById('check-btn').classList.add('hidden');
                document.getElementById('next-btn').classList.remove('hidden');
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid), { score: increment(10) });
            } else {
                f.innerText = "í‹€ë ¸ìŠµë‹ˆë‹¤."; f.style.opacity = '1';
            }
        };

        document.getElementById('next-btn').onclick = () => { currentIdx++; loadQuiz(); };
        document.getElementById('reset-btn').onclick = loadQuiz;
        document.getElementById('rank-btn').onclick = () => document.getElementById('rank-modal').classList.add('active');
        document.getElementById('rank-close').onclick = () => document.getElementById('rank-modal').classList.remove('active');
        document.getElementById('admin-btn').onclick = () => document.getElementById('admin-modal').classList.add('active');
        document.getElementById('admin-close').onclick = () => document.getElementById('admin-modal').classList.remove('active');

        function renderRank(l) {
            document.getElementById('rank-list').innerHTML = l.map((u,i) => `<div class="flex justify-between p-3 bg-slate-50 rounded-xl"><span>${i+1}. ${u.nickname}</span><b>${u.score}</b></div>`).join('');
        }
        function updateAdminList() {
            document.getElementById('admin-quiz-list').innerHTML = quizzes.map(q => `
                <div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl text-xs">
                    <div class="flex-1 mr-2">
                        <p class="font-bold text-slate-800">${q.en}</p>
                        <p class="text-slate-500">${q.ko}</p>
                    </div>
                    <button onclick="window.del('${q.id}')" class="text-red-500 font-bold px-2 py-1 bg-red-50 rounded-lg">ì‚­ì œ</button>
                </div>
            `).join('');
        }
        window.del = (id) => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'quizzes', id));
    </script>
</body>
</html>