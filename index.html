<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Scramble - GitHub Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Pretendard', sans-serif; transition: all 0.3s; }
        .word-tile { transition: all 0.2s; cursor: pointer; user-select: none; }
        .word-tile.selected { opacity: 0.3; pointer-events: none; }
        .drop-zone { min-height: 80px; border: 2px dashed #e2e8f0; border-radius: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 100; align-items: center; justify-content: center; padding: 1rem; }
        .modal.active { display: flex; }
        #custom-alert { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; }
        .spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 3px solid #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col items-center p-4">

    <!-- ì•Œë¦¼ ë©”ì‹œì§€ -->
    <div id="custom-alert" class="bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl font-bold text-sm animate-bounce"></div>

    <!-- ë‹‰ë„¤ì„ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="login-modal" class="modal active">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-10 shadow-2xl text-center border border-slate-100">
            <h2 class="text-3xl font-black text-slate-800 mb-2">AI Scramble</h2>
            <p class="text-slate-500 mb-8">í•™ìŠµì„ ì‹œì‘í•˜ë ¤ë©´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
            <input type="text" id="user-nickname" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" 
                   class="w-full p-4 rounded-2xl border border-slate-200 mb-4 outline-none focus:ring-4 focus:ring-indigo-500/20 text-center font-bold text-lg">
            <button id="start-btn" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black text-lg hover:bg-indigo-700 transition-all shadow-xl">í•™ìŠµ ì‹œì‘í•˜ê¸°</button>
            <p id="auth-error-hint" class="mt-4 text-xs text-red-500 hidden font-semibold">Firebase ì„¤ì •ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ì½”ë“œë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.</p>
        </div>
    </div>

    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="w-full max-w-2xl flex justify-between items-center mb-6 py-2 px-4">
        <div class="flex items-center gap-3">
            <div id="user-avatar" class="w-11 h-11 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center text-white font-black shadow-lg">?</div>
            <div>
                <p id="display-name" class="text-sm font-black text-slate-700">GUEST</p>
                <p class="text-[11px] font-bold text-slate-400 uppercase tracking-tighter">Live Learning</p>
            </div>
        </div>
        <div class="flex gap-2.5">
            <button id="settings-btn" class="p-3 rounded-2xl bg-white shadow-sm border border-slate-200 hover:bg-slate-50">ğŸ”‘ AI ì„¤ì •</button>
            <button id="admin-btn" class="p-3 rounded-2xl bg-white shadow-sm border border-slate-200 hover:bg-slate-50">âš™ï¸ ê´€ë¦¬</button>
        </div>
    </nav>

    <!-- ë©”ì¸ ê²Œì„ ì˜ì—­ -->
    <main id="game-container" class="w-full max-w-2xl bg-white shadow-2xl rounded-[3rem] p-8 md:p-12 border border-slate-100 relative overflow-hidden">
        <div class="flex justify-between items-start mb-8">
            <div class="flex-1">
                <div id="level-badge" class="inline-block px-3 py-1 bg-indigo-50 text-indigo-600 rounded-lg text-[10px] font-black uppercase mb-3">Sentence 0 / 0</div>
                <h2 id="translation" class="text-2xl md:text-3xl font-black text-slate-800 leading-tight">ë¬¸ì¥ì„ ìƒì„±í•´ ì£¼ì„¸ìš”.</h2>
            </div>
            <div class="bg-slate-50 p-4 rounded-[1.5rem] text-center min-w-[100px]">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Score</p>
                <p id="score-display" class="text-3xl font-black text-indigo-600">0</p>
            </div>
        </div>
        <div id="answer-zone" class="drop-zone p-5 bg-slate-50/50 mb-8"></div>
        <div id="word-pool" class="flex flex-wrap gap-2.5 justify-center mb-12"></div>
        <div class="grid grid-cols-2 gap-4">
            <button id="reset-btn" class="py-5 bg-slate-100 text-slate-600 rounded-[1.5rem] font-black hover:bg-slate-200">ì´ˆê¸°í™”</button>
            <button id="check-btn" class="py-5 bg-indigo-600 text-white rounded-[1.5rem] font-black hover:bg-indigo-700">ì •ë‹µ í™•ì¸</button>
            <button id="next-btn" class="hidden col-span-2 py-5 bg-emerald-500 text-white rounded-[1.5rem] font-black hover:bg-emerald-600">ë‹¤ìŒ ë¬¸ì¥ìœ¼ë¡œ</button>
        </div>
        <div id="feedback" class="mt-8 text-center font-black text-xl opacity-0 h-8 transition-opacity"></div>
    </main>

    <!-- ì„¤ì • ëª¨ë‹¬ -->
    <div id="settings-modal" class="modal">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-10 shadow-2xl relative">
            <button id="settings-close" class="absolute top-6 right-6 font-bold text-2xl">&times;</button>
            <h3 class="text-2xl font-black mb-4">Gemini API ì„¤ì •</h3>
            <p class="text-sm text-slate-500 mb-6 leading-relaxed">ë³¸ì¸ì˜ API í‚¤ë¥¼ ì…ë ¥í•´ì•¼ AI ìƒì„±ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</p>
            <input type="password" id="api-key-input" placeholder="AIZA..." 
                   class="w-full p-4 rounded-2xl border border-slate-200 mb-4 outline-none focus:ring-2 focus:ring-indigo-500">
            <button id="save-api-key" class="w-full py-4 bg-slate-800 text-white rounded-2xl font-black hover:bg-slate-900 transition-colors">ì €ì¥í•˜ê¸°</button>
        </div>
    </div>

    <!-- ê´€ë¦¬ì ëª¨ë‹¬ -->
    <div id="admin-modal" class="modal">
        <div class="bg-white w-full max-w-2xl rounded-[2.5rem] p-10 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-2xl font-black">AI ë¬¸ì¥ ê´€ë¦¬</h3>
                <button id="admin-close" class="text-2xl">&times;</button>
            </div>
            <div class="bg-indigo-50 p-6 rounded-[2rem] mb-8">
                <p class="text-indigo-600 font-black text-sm mb-4">âœ¨ AI ë¬¸ì¥ ìƒì„± (Gemini API)</p>
                <div class="flex gap-2">
                    <input type="text" id="ai-prompt" placeholder="ì£¼ì œ (ì˜ˆ: ì·¨ë¯¸, ì—¬í–‰)" class="flex-1 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-300">
                    <button id="generate-ai-btn" class="px-8 bg-indigo-600 text-white rounded-2xl font-black flex items-center justify-center min-w-[100px]">ìƒì„±</button>
                </div>
            </div>
            <div id="admin-quiz-list" class="space-y-3"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, updateDoc, increment, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // [ì¤‘ìš”] GitHub Pagesì—ì„œ ì—°ë™í•˜ë ¤ë©´ ì´ ê°’ì„ ì‹¤ì œ ë³¸ì¸ì˜ Firebase ì •ë³´ë¡œ ì±„ì›Œì•¼ í•©ë‹ˆë‹¤.
        // ì±„ìš°ì§€ ì•Šìœ¼ë©´ ì•±ì€ ë¡œì»¬ ëª¨ë“œë¡œ ë™ì‘ì„ ì‹œë„í•©ë‹ˆë‹¤.
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const isFirebaseValid = firebaseConfig.apiKey !== "YOUR_FIREBASE_API_KEY";
        let db, auth;
        const appId = 'scramble-github-v1';

        if (isFirebaseValid) {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } else {
            console.warn("Firebase config is placeholder. Firestore features disabled.");
        }

        let quizzes = [];
        let currentIdx = 0;
        let selectedWords = [];
        let currentUser = null;
        let score = 0;

        function showMsg(m) {
            const a = document.getElementById('custom-alert');
            a.innerText = m; a.style.display = 'block';
            setTimeout(() => a.style.display = 'none', 3000);
        }

        let savedApiKey = localStorage.getItem('GEMINI_API_KEY') || "";
        document.getElementById('api-key-input').value = savedApiKey;

        document.getElementById('save-api-key').onclick = () => {
            const key = document.getElementById('api-key-input').value.trim();
            if(!key) return showMsg("í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            localStorage.setItem('GEMINI_API_KEY', key);
            savedApiKey = key;
            showMsg("API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            document.getElementById('settings-modal').classList.remove('active');
        };

        const initAuth = async () => {
            if (!isFirebaseValid) return;
            try {
                await signInAnonymously(auth);
            } catch (e) {
                console.error("Auth Error:", e);
                document.getElementById('auth-error-hint').classList.remove('hidden');
                showMsg("Firebase API í‚¤ ì—ëŸ¬! ì½”ë“œë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
            }
        };
        initAuth();

        document.getElementById('start-btn').onclick = async () => {
            const nick = document.getElementById('user-nickname').value.trim();
            if(!nick) return showMsg("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            
            document.getElementById('display-name').innerText = nick;
            document.getElementById('user-avatar').innerText = nick.charAt(0);
            
            if (isFirebaseValid && auth.currentUser) {
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', auth.currentUser.uid);
                await setDoc(userRef, { nickname: nick, score: 0, lastUpdated: Date.now() }, { merge: true });
            }
            document.getElementById('login-modal').classList.remove('active');
        };

        if (isFirebaseValid) {
            onAuthStateChanged(auth, (user) => {
                if(user) {
                    currentUser = user;
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'quizzes'), (snap) => {
                        const l = []; snap.forEach(d => l.push({id: d.id, ...d.data()}));
                        quizzes = l.sort((a,b) => (a.createdAt || 0) - (b.createdAt || 0));
                        if(quizzes.length > 0) loadQuiz();
                        updateAdminList();
                    });
                    onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid), (snap) => {
                        if(snap.exists()) {
                            const d = snap.data();
                            score = d.score || 0;
                            document.getElementById('score-display').innerText = score;
                        }
                    });
                }
            });
        }

        document.getElementById('generate-ai-btn').onclick = async () => {
            if(!savedApiKey) {
                showMsg("ì„¤ì •ì—ì„œ API Keyë¥¼ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.");
                document.getElementById('settings-modal').classList.add('active');
                return;
            }

            const prompt = document.getElementById('ai-prompt').value.trim();
            if (!prompt) return showMsg("ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

            const btn = document.getElementById('generate-ai-btn');
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner"></span>ìƒì„± ì¤‘...`;

            try {
                const sys = "You are an English teacher. Create ONE English sentence about the user's topic. Response must be JSON: {\"en\": \"sentence\", \"ko\": \"translation\"}";
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${savedApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Topic: ${prompt}` }] }],
                        systemInstruction: { parts: [{ text: sys }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                if (!res.ok) throw new Error("API Key ì˜¤ë¥˜ ë˜ëŠ” í• ë‹¹ëŸ‰ ì´ˆê³¼");
                
                const data = await res.json();
                const jsonStr = data.candidates[0].content.parts[0].text;
                const quizData = JSON.parse(jsonStr);
                
                if (isFirebaseValid) {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'quizzes'), {
                        ...quizData,
                        createdAt: Date.now()
                    });
                } else {
                    quizzes.push({ id: Date.now().toString(), ...quizData });
                    loadQuiz();
                    updateAdminList();
                }

                showMsg("ë¬¸ì¥ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
                document.getElementById('ai-prompt').value = '';
            } catch (e) {
                showMsg("AI ìƒì„± ì‹¤íŒ¨: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "ìƒì„±";
            }
        };

        function loadQuiz() {
            if(quizzes.length === 0) return;
            const q = quizzes[currentIdx % quizzes.length];
            document.getElementById('translation').innerText = q.ko;
            document.getElementById('level-badge').innerText = `Sentence ${currentIdx + 1} / ${quizzes.length}`;
            document.getElementById('word-pool').innerHTML = '';
            document.getElementById('answer-zone').innerHTML = '';
            document.getElementById('feedback').style.opacity = '0';
            document.getElementById('check-btn').classList.remove('hidden');
            document.getElementById('next-btn').classList.add('hidden');
            selectedWords = [];

            const words = q.en.split(/\s+/).filter(w => w.length > 0);
            [...words].sort(() => Math.random()-0.5).forEach(w => {
                const b = document.createElement('div');
                b.className = 'word-tile bg-white border border-slate-200 shadow-sm p-4 rounded-xl font-bold hover:border-indigo-500';
                b.innerText = w;
                b.onclick = () => {
                    if(b.classList.contains('selected')) return;
                    b.classList.add('selected');
                    const t = document.createElement('div');
                    t.className = 'word-tile bg-indigo-600 text-white p-4 rounded-xl font-bold shadow-md';
                    t.innerText = w;
                    t.onclick = () => { 
                        b.classList.remove('selected'); 
                        t.remove(); 
                        selectedWords = selectedWords.filter(s => s.t !== t); 
                    };
                    document.getElementById('answer-zone').appendChild(t);
                    selectedWords.push({w, t});
                };
                document.getElementById('word-pool').appendChild(b);
            });
        }

        document.getElementById('check-btn').onclick = async () => {
            if(selectedWords.length === 0) return;
            const userStr = selectedWords.map(s => s.w.toLowerCase().replace(/[.?!,]/g,"")).join(' ');
            const correctStr = quizzes[currentIdx % quizzes.length].en.toLowerCase().replace(/[.?!,]/g,"");
            
            const fb = document.getElementById('feedback');
            if(userStr === correctStr) {
                fb.innerText = "ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰"; 
                fb.className = "mt-8 text-center font-black text-xl text-emerald-500 opacity-100";
                document.getElementById('check-btn').classList.add('hidden');
                document.getElementById('next-btn').classList.remove('hidden');
                if (isFirebaseValid && currentUser) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid), { score: increment(10) });
                } else {
                    score += 10;
                    document.getElementById('score-display').innerText = score;
                }
            } else {
                fb.innerText = "ë‹¤ì‹œ í•œ ë²ˆ ìƒê°í•´ë³´ì„¸ìš”. ğŸ’¡"; 
                fb.className = "mt-8 text-center font-black text-xl text-red-400 opacity-100";
            }
        };

        document.getElementById('next-btn').onclick = () => { currentIdx++; loadQuiz(); };
        document.getElementById('reset-btn').onclick = loadQuiz;
        document.getElementById('settings-btn').onclick = () => document.getElementById('settings-modal').classList.add('active');
        document.getElementById('settings-close').onclick = () => document.getElementById('settings-modal').classList.remove('active');
        document.getElementById('admin-btn').onclick = () => document.getElementById('admin-modal').classList.add('active');
        document.getElementById('admin-close').onclick = () => document.getElementById('admin-modal').classList.remove('active');

        function updateAdminList() {
            document.getElementById('admin-quiz-list').innerHTML = quizzes.map(q => `
                <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl border border-slate-100">
                    <div class="flex-1 mr-4 overflow-hidden">
                        <p class="font-bold text-slate-800 truncate">${q.en}</p>
                        <p class="text-xs text-slate-500 truncate">${q.ko}</p>
                    </div>
                    <button onclick="window.del('${q.id}')" class="text-red-500 bg-white border border-red-100 px-3 py-1.5 rounded-xl text-xs font-bold hover:bg-red-50">ì‚­ì œ</button>
                </div>
            `).join('');
        }
        window.del = (id) => { 
            if(confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) {
                if (isFirebaseValid) {
                    deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'quizzes', id));
                } else {
                    quizzes = quizzes.filter(q => q.id !== id);
                    updateAdminList();
                    loadQuiz();
                }
            }
        };
    </script>
</body>
</html>
